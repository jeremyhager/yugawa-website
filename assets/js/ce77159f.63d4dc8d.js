"use strict";(self.webpackChunkyugawa=self.webpackChunkyugawa||[]).push([[44],{3905:function(e,t,s){s.d(t,{Zo:function(){return u},kt:function(){return d}});var r=s(7294);function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,r)}return s}function o(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){a(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function p(e,t){if(null==e)return{};var s,r,a=function(e,t){if(null==e)return{};var s,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)s=l[r],t.indexOf(s)>=0||(a[s]=e[s]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)s=l[r],t.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(a[s]=e[s])}return a}var n=r.createContext({}),i=function(e){var t=r.useContext(n),s=t;return e&&(s="function"==typeof e?e(t):o(o({},t),e)),s},u=function(e){var t=i(e.components);return r.createElement(n.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var s=e.components,a=e.mdxType,l=e.originalType,n=e.parentName,u=p(e,["components","mdxType","originalType","parentName"]),c=i(s),d=a,m=c["".concat(n,".").concat(d)]||c[d]||g[d]||l;return s?r.createElement(m,o(o({ref:t},u),{},{components:s})):r.createElement(m,o({ref:t},u))}));function d(e,t){var s=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=s.length,o=new Array(l);o[0]=c;var p={};for(var n in t)hasOwnProperty.call(t,n)&&(p[n]=t[n]);p.originalType=e,p.mdxType="string"==typeof e?e:a,o[1]=p;for(var i=2;i<l;i++)o[i]=s[i];return r.createElement.apply(null,o)}return r.createElement.apply(null,s)}c.displayName="MDXCreateElement"},2321:function(e,t,s){s.r(t),s.d(t,{assets:function(){return u},contentTitle:function(){return n},default:function(){return d},frontMatter:function(){return p},metadata:function(){return i},toc:function(){return g}});var r=s(7462),a=s(3366),l=(s(7294),s(3905)),o=["components"],p={id:"pgpool-II-setup",title:"pgpool-II setup",sidebar_label:"pgpool-II setup"},n=void 0,i={unversionedId:"pgpool-II-setup",id:"pgpool-II-setup",title:"pgpool-II setup",description:"On both VMs",source:"@site/docs/pgpool-II-setup.md",sourceDirName:".",slug:"/pgpool-II-setup",permalink:"/pgpool-II-setup",draft:!1,editUrl:"https://github.com/jeremyhager/yugawa-website/edit/main/docs/pgpool-II-setup.md",tags:[],version:"current",frontMatter:{id:"pgpool-II-setup",title:"pgpool-II setup",sidebar_label:"pgpool-II setup"}},u={},g=[{value:"On both VMs",id:"on-both-vms",level:2},{value:"Create archive for postgresql",id:"create-archive-for-postgresql",level:3},{value:"Set up pgpool on postgresql1",id:"set-up-pgpool-on-postgresql1",level:2},{value:"Install pgpool-II for postgresql 12",id:"install-pgpool-ii-for-postgresql-12",level:3},{value:"Install pgpool-II debug tool",id:"install-pgpool-ii-debug-tool",level:3},{value:"configure postgresql.conf",id:"configure-postgresqlconf",level:3},{value:"Create postgresql users",id:"create-postgresql-users",level:3},{value:"Allow passwordless ssh on all servers",id:"allow-passwordless-ssh-on-all-servers",level:2},{value:"Generate ssh files for root",id:"generate-ssh-files-for-root",level:3},{value:"Copy public keys into authorized_keys",id:"copy-public-keys-into-authorized_keys",level:3},{value:"Generate ssh files for postgres",id:"generate-ssh-files-for-postgres",level:3},{value:"Test passwordless ssh",id:"test-passwordless-ssh",level:3},{value:"Sources",id:"sources",level:2}],c={toc:g};function d(e){var t=e.components,s=(0,a.Z)(e,o);return(0,l.kt)("wrapper",(0,r.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"on-both-vms"},"On both VMs"),(0,l.kt)("h3",{id:"create-archive-for-postgresql"},"Create archive for postgresql"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'sudo su postgres -c "mkdir /var/lib/pgsql/12/archive"\n')),(0,l.kt)("h2",{id:"set-up-pgpool-on-postgresql1"},"Set up pgpool on postgresql1"),(0,l.kt)("h3",{id:"install-pgpool-ii-for-postgresql-12"},"Install pgpool-II for postgresql 12"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo yum -y install pgpool-II-pg12\n")),(0,l.kt)("h3",{id:"install-pgpool-ii-debug-tool"},"Install pgpool-II debug tool"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo yum -y install pgpool-II-pg12-debuginfo\n")),(0,l.kt)("h3",{id:"configure-postgresqlconf"},"configure postgresql.conf"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-clike",metastring:'title="/var/lib/pgsql/12/data/postgresql.conf"',title:'"/var/lib/pgsql/12/data/postgresql.conf"'},"listen_addresses = '*'\n...\narchive_mode = on\narchive_command = 'cp \"%p\" \"/var/lib/pgsql/12/archive/%f\"'\n...\nmax_wal_senders = 10\n...\nmax_replication_slots = 10\n...\nwal_level = replica\n...\nhot_standby = on\n...\nwal_log_hints = on\n")),(0,l.kt)("h3",{id:"create-postgresql-users"},"Create postgresql users"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo su - postgres -c psql\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE ROLE pgpool WITH LOGIN;\nCREATE ROLE repl WITH REPLICATION LOGIN;\n\\password pgpool\n\\password repl\n\\password postgres\n")),(0,l.kt)("p",null,"Grant pg_monitor to pgpool:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT pg_monitor TO pgpool;\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-clike",metastring:'title="/var/lib/pgsql/12/data/pg_hba.conf"',title:'"/var/lib/pgsql/12/data/pg_hba.conf"'},"host    all             all             samenet                 md5\nhost    replication     all             samenet                 md5\n")),(0,l.kt)("h2",{id:"allow-passwordless-ssh-on-all-servers"},"Allow passwordless ssh on all servers"),(0,l.kt)("h3",{id:"generate-ssh-files-for-root"},"Generate ssh files for root"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="all servers"',title:'"all','servers"':!0},"sudo ssh-keygen -t rsa -f id_rsa_pgpool\n")),(0,l.kt)("p",null,"Copy files to servers"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'},"sudo scp id_rsa_pgpool.pub jeremy@postgresql2.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql1.pub\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'},"sudo scp id_rsa_pgpool.pub jeremy@postgresql1.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql2.pub\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text",metastring:'title="expected output"',title:'"expected','output"':!0},"Password:\nPassword:\nPassword:\njeremy@postgresql1.internal.virtnet's password: \n")),(0,l.kt)("p",null,"When asked for passwords, simply hit enter and leave blank. When asked for the user's password to a postgres server enter in the password for that user."),(0,l.kt)("h3",{id:"copy-public-keys-into-authorized_keys"},"Copy public keys into authorized_keys"),(0,l.kt)("p",null,"Use postgres by creating directories and files, and adjusting permissions:"),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"This is normally done via ",(0,l.kt)("inlineCode",{parentName:"p"},"ssh-copy-id"),", however for postgres a manual method is needed."))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo su - postgres -c 'mkdir -p ~postgres/.ssh'\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo su - postgres -c 'touch ~postgres/.ssh/authorized_keys'\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'},"sudo sh -c 'cat id_rsa_pgpool_psql2.pub >> ~postgres/.ssh/authorized_keys'\nsudo rm id_rsa_pgpool_psql2.pub\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'},"sudo sh -c 'cat id_rsa_pgpool_psql1.pub >> ~postgres/.ssh/authorized_keys'\nsudo rm id_rsa_pgpool_psql1.pub\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo su - postgres -c 'chmod 700 ~postgres/.ssh'\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo su - postgres -c 'chmod 600 ~postgres/.ssh/authorized_keys'\n")),(0,l.kt)("h3",{id:"generate-ssh-files-for-postgres"},"Generate ssh files for postgres"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo su - postgres\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/.ssh\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t rsa -f id_rsa_pgpool\n")),(0,l.kt)("p",null,"Copy files to servers"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'},"scp id_rsa_pgpool.pub jeremy@postgresql2.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql-postgres1.pub\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'},"scp id_rsa_pgpool.pub jeremy@postgresql1.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql-postgres2.pub\n")),(0,l.kt)("p",null,"Exit postgres user"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"exit\n")),(0,l.kt)("p",null,"Copy psql-postgres.pub files"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'},"sudo sh -c 'cat id_rsa_pgpool_psql-postgres2.pub >> ~postgres/.ssh/authorized_keys'\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"rm id_rsa_pgpool_psql-postgres2.pub\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'},"sudo sh -c 'cat id_rsa_pgpool_psql-postgres1.pub >> ~postgres/.ssh/authorized_keys'\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"rm id_rsa_pgpool_psql-postgres1.pub\n")),(0,l.kt)("h3",{id:"test-passwordless-ssh"},"Test passwordless ssh"),(0,l.kt)("h2",{id:"sources"},"Sources"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.pgpool.net/docs/42/en/html/example-cluster.html"},"pgpool-II and watchdog example")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://unix.stackexchange.com/a/106482"},"copy via scp")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://stackoverflow.com/a/82278/14952836"},"run append as root"))))}d.isMDXComponent=!0}}]);